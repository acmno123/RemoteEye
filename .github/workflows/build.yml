name: RemoteEye Build and Release

on:
  push:
    tags:
      - 'v*' # 當你推送標籤如 v1.0.0 時才啟動，避免浪費資源

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter mss pillow pyautogui pyinstaller
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev libx11-dev libxext-dev libxinerama-dev libxrandr-dev libxcursor-dev
        fi
      shell: bash

    - name: Build Executable
      shell: bash
      run: |
        CTK_PATH=$(python -c "import customtkinter; import os; print(customtkinter.__path__[0])")
        SEP=$([[ "${{ matrix.os }}" == "windows-latest" ]] && echo ";" || echo ":")
        
        # 產出單一執行檔
        python -m PyInstaller --noconfirm --onefile --windowed --add-data "${CTK_PATH}${SEP}customtkinter/" RemoteEye_Global.py

    # --- [新增] Linux 轉 AppImage 邏輯 ---
    - name: Package AppImage (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        # 建立簡單的 AppDir 結構並打包 (簡化流程)
        mkdir -p AppDir/usr/bin
        cp dist/RemoteEye_Global AppDir/usr/bin/
        echo -e '#!/bin/sh\nexec ./usr/bin/RemoteEye_Global "$@"' > AppDir/AppRun
        chmod +x AppDir/AppRun
        echo "[Desktop Entry]\nName=RemoteEye\nExec=RemoteEye_Global\nIcon=icon\nType=Application\nCategories=Utility;" > AppDir/remoteeye.desktop
        touch AppDir/icon.png
        ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir dist/RemoteEye_Global.AppImage

    # --- [新增] macOS 轉 DMG 邏輯 ---
    - name: Create DMG (macOS only)
      if: matrix.os == 'macos-latest'
      run: |
        npm install -g create-dmg
        create-dmg dist/RemoteEye_Global.app dist/ || true
        # 重新命名以確保檔名正確
        mv dist/*.dmg dist/RemoteEye_Global.dmg

    - name: Release to GitHub
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/*.exe
          dist/*.dmg
          dist/*.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}