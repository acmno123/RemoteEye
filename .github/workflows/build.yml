name: RemoteEye Build and Release

on:
  push:
    tags:
      - 'v*' # 只有當你推標籤（如 v1.0.0）時才會正式發布下載檔

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter mss pillow pyautogui pyinstaller
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev libx11-dev libxext-dev libxinerama-dev libxrandr-dev libxcursor-dev
        fi
      shell: bash

    - name: Build Executable
      shell: bash
      run: |
        CTK_PATH=$(python -c "import customtkinter; import os; print(customtkinter.__path__[0])")
        SEP=$([[ "${{ matrix.os }}" == "windows-latest" ]] && echo ";" || echo ":")
        
        # 執行 PyInstaller 打包
        python -m PyInstaller --noconfirm --onefile --windowed --name "RemoteEye" --add-data "${CTK_PATH}${SEP}customtkinter/" RemoteEye_Global.py

    # --- [Linux 處理] 將執行檔轉為 AppImage ---
    - name: Package AppImage (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
        chmod +x appimagetool
        mkdir -p AppDir/usr/bin
        cp dist/RemoteEye AppDir/usr/bin/
        echo -e '#!/bin/sh\nexec ./usr/bin/RemoteEye "$@"' > AppDir/AppRun
        chmod +x AppDir/AppRun
        echo -e "[Desktop Entry]\nName=RemoteEye\nExec=RemoteEye\nIcon=icon\nType=Application\nCategories=Utility;" > AppDir/remoteeye.desktop
        touch AppDir/icon.png
        ARCH=x86_64 ./appimagetool --appimage-extract-and-run AppDir dist/RemoteEye.AppImage

    # --- [macOS 處理] 將 .app 轉為 .dmg ---
    - name: Create DMG (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # 使用簡單的 hdiutil 製作 dmg
        hdiutil create -format UDZO -srcfolder dist/RemoteEye.app dist/RemoteEye.dmg

    # --- [正式發布] 這是關鍵！它會把檔案放到 Releases 頁面，而不是 Artifacts ---
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/RemoteEye.exe
          dist/RemoteEye.dmg
          dist/RemoteEye.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}