name: RemoteEye Build and Release

on:
  push:
    tags:
      - 'v*'

# --- 重點：開啟 Release 寫入權限 ---
permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter mss pillow pyautogui pyinstaller
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev libx11-dev libxext-dev libxinerama-dev libxrandr-dev libxcursor-dev
        fi
      shell: bash

    - name: Build Executable
      shell: bash
      run: |
        CTK_PATH=$(python -c "import customtkinter; import os; print(customtkinter.__path__[0])")
        SEP=$([[ "${{ matrix.os }}" == "windows-latest" ]] && echo ";" || echo ":")
        # 統一輸出名稱為 RemoteEye
        python -m PyInstaller --noconfirm --onefile --windowed --name "RemoteEye" --add-data "${CTK_PATH}${SEP}customtkinter/" RemoteEye_Global.py

    # --- [修正版] Linux 轉 AppImage ---
    - name: Package AppImage (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # 使用更穩定的連續構建版本載點
        wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool
        
        # 建立 AppDir 結構
        mkdir -p AppDir/usr/bin
        cp dist/RemoteEye AppDir/usr/bin/
        
        # 寫入啟動腳本
        echo -e '#!/bin/sh\nexec ./usr/bin/RemoteEye "$@"' > AppDir/AppRun
        chmod +x AppDir/AppRun
        
        # 建立桌面入口檔案
        echo -e "[Desktop Entry]\nName=RemoteEye\nExec=RemoteEye\nIcon=remoteeye\nType=Application\nCategories=Utility;" > AppDir/remoteeye.desktop
        
        # 建立一個空白圖示避免報錯
        touch AppDir/remoteeye.png
        
        # 打包成 AppImage (加上 --appimage-extract-and-run 以相容 GitHub 環境)
        ARCH=x86_64 ./appimagetool --appimage-extract-and-run AppDir dist/RemoteEye.AppImage
      shell: bash

    # --- macOS 轉 DMG ---
    - name: Create DMG (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        hdiutil create -format UDZO -srcfolder dist/RemoteEye.app dist/RemoteEye.dmg

    - name: Upload to Release
      uses: softprops/action-gh-release@v2  # 使用較新的 v2 版本
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/RemoteEye.exe
          dist/RemoteEye.dmg
          dist/RemoteEye.AppImage
          dist/RemoteEye
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}